services:
  envoy-builder:
    image: envoy-devcontainer
    container_name: envoy-builder
    platform: linux/arm64
    user: vscode
    cap_drop:
      - DAC_OVERRIDE
    volumes:
      - .:/workspace
      - ./build:/build
      - bazel-cache:/root/.cache/bazel
    working_dir: /workspace/envoy
    command: >
      sh -c "BAZEL_BUILD_EXTRA_OPTIONS='--define tcmalloc=gperftools' ./ci/do_ci.sh bazel.release.server_only"
    stdin_open: true
    tty: true

volumes:
  bazel-cache:
